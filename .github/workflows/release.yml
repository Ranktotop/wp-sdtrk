name: Build & Release Plugin

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ§° Setup PHP & Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: ğŸ“¦ Install Composer Dependencies (no dev)
        run: composer install --no-dev --optimize-autoloader

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ“¦ Install Terser for JS Minification
        run: npm install -g terser

      - name: ğŸ—œï¸ Minify JavaScript Files
        run: |
          echo "Starting JavaScript minification..."
          
          # PrÃ¼fe ob public/js existiert
          if [ -d "public/js" ]; then
            # Finde alle .js Dateien (auÃŸer bereits minifizierte .min.js)
            find public/js -type f -name "*.js" ! -name "*.min.js" | while read jsfile; do
              # Extrahiere Dateiname ohne Erweiterung
              filename="${jsfile%.js}"
              minfile="${filename}.min.js"
              
              echo "Minifying: $jsfile -> $minfile"
              
              # Minifiziere mit Terser
              terser "$jsfile" \
                --compress \
                --mangle \
                --output "$minfile" \
                --comments false
              
              if [ $? -eq 0 ]; then
                echo "âœ… Successfully minified: $minfile"
              else
                echo "âŒ Error minifying: $jsfile"
                exit 1
              fi
            done
            
            echo "âœ… All JavaScript files minified successfully"
          else
            echo "âš ï¸ Directory public/js not found"
            exit 1
          fi

      - name: ğŸ”„ Update loadMinified Switch
        run: |
          echo "Updating \$loadMinified switch in public/class-wp-sdtrk-public.php..."
          
          if [ -f "public/class-wp-sdtrk-public.php" ]; then
            # Ersetze $loadMinified = false; mit $loadMinified = true;
            sed -i 's/\$loadMinified = false;/\$loadMinified = true;/g' public/class-wp-sdtrk-public.php
            
            # PrÃ¼fe ob die Ã„nderung erfolgreich war
            if grep -q '\$loadMinified = true;' public/class-wp-sdtrk-public.php; then
              echo "âœ… Successfully updated \$loadMinified to true"
            else
              echo "âŒ Failed to update \$loadMinified switch"
              exit 1
            fi
          else
            echo "âŒ File public/class-wp-sdtrk-public.php not found"
            exit 1
          fi

      - name: ğŸ—œï¸ Create Plugin ZIP
        run: |
          mkdir -p release
          zip -r release/wp-sdtrk.zip . \
            -x ".git*" ".github/*" "temp/*" "tests/*" "*.md" "composer.*" "phpunit.*" "node_modules/*"

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: release/wp-sdtrk.zip
          body: |
            ## Release ${{ github.ref_name }}
            
            ### ğŸ“¦ Changes
            - âœ… JavaScript files minified
            - âœ… Production mode enabled
            - ğŸ¯ Ready for deployment
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}